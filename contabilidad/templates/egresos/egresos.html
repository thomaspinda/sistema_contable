{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Registrar Egreso{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="card shadow border-danger mb-5">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">Nuevo Egreso (Compra/Gasto)</h4>
                </div>
                
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row">
                            {% for field in form %}
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-secondary">{{ field.label }}</label>
                                    {{ field|add_class:"form-control" }}
                                    {% if field.errors %}
                                        <div class="text-danger small">{{ field.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3 text-danger">Detalle de Items</h5>
                        <div class="table-responsive mb-3">
                            <table class="table table-bordered align-middle" id="tablaCompras">
                                <thead class="table-danger">
                                    <tr>
                                        <th style="width: 40%;">Producto / Concepto</th>
                                        <th style="width: 15%;">Cantidad</th>
                                        <th style="width: 20%;">Costo Unit.</th>
                                        <th style="width: 20%;">Subtotal</th> 
                                        <th style="width: 5%;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold">Total Estimado:</td>
                                        <td class="text-end fw-bold text-danger fs-5" id="granTotal">$0.00</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <button type="button" class="btn btn-outline-danger btn-sm mb-4" onclick="agregarFilaCompra()">
                            + Agregar Item
                        </button>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-danger btn-lg shadow-sm">Registrar Egreso</button>
                            <a href="{% url 'dashboard' %}" class="btn btn-link text-muted">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-secondary">Historial de Egresos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Factura</th>
                                    <th>Costo</th>
                                    <th>Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for egreso in egresos %}
                                    <tr>
                                        <td>{{ egreso.fecha|date:"d/m/Y" }}</td>
                                        <td>{{ egreso.titulo }}</td>
                                        <td>{{ egreso.numero_factura|default:"-" }}</td>
                                        <td><span class="badge bg-danger">${{ egreso.costo }}</span></td>
                                        <td class="small text-muted">{{ egreso.creado_por.username }}</td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="5" class="text-center py-3 text-muted">No hay egresos registrados.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<datalist id="catalogo_productos"></datalist>

<script>
    // Lógica JS Original mantenida y adaptada al nuevo estilo
    const preciosReferencia = {{ precios_json|safe }};

    document.addEventListener('DOMContentLoaded', function() {
        const datalist = document.getElementById('catalogo_productos');
        datalist.innerHTML = ''; 
        Object.keys(preciosReferencia).forEach(nombre => {
            let option = document.createElement('option');
            option.value = nombre;
            datalist.appendChild(option);
        });
        agregarFilaCompra();
    });

    function agregarFilaCompra() {
        let tbody = document.querySelector('#tablaCompras tbody');
        let tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <input type="text" name="nombre_producto[]" class="form-control" 
                       list="catalogo_productos" placeholder="Buscar..." 
                       oninput="detectarPrecio(this)" required autocomplete="off">
            </td>
            <td>
                <input type="number" name="cantidad[]" class="form-control" 
                       min="1" value="1" oninput="calcularSubtotal(this)" required>
            </td>
            <td>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" name="precio_unitario[]" class="form-control" 
                        step="0.01" placeholder="0.00" oninput="calcularSubtotal(this)" required>
                </div>
            </td>
            <td class="text-end align-middle">
                <span class="subtotal-display fw-bold text-dark">$0.00</span>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="eliminarFila(this)">×</button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    function detectarPrecio(inputNombre) {
        let fila = inputNombre.closest('tr');
        let inputPrecio = fila.querySelector('input[name="precio_unitario[]"]');
        let nombre = inputNombre.value;
        let precioEncontrado = preciosReferencia[nombre] || 
                               (preciosReferencia[Object.keys(preciosReferencia).find(k => k.toLowerCase() === nombre.toLowerCase())]);

        if (precioEncontrado) {
            inputPrecio.value = precioEncontrado;
            calcularSubtotal(inputPrecio); 
        }
    }

    function calcularSubtotal(elemento) {
        let fila = elemento.closest('tr');
        let cantidad = parseFloat(fila.querySelector('input[name="cantidad[]"]').value) || 0;
        let precio = parseFloat(fila.querySelector('input[name="precio_unitario[]"]').value) || 0;
        let subtotal = cantidad * precio;
        
        fila.querySelector('.subtotal-display').textContent = "$" + subtotal.toFixed(2);
        actualizarGranTotal();
    }

    function actualizarGranTotal() {
        let total = 0;
        document.querySelectorAll('.subtotal-display').forEach(span => {
            total += parseFloat(span.textContent.replace('$', '')) || 0;
        });
        document.getElementById('granTotal').textContent = "$" + total.toFixed(2);
    }

    function eliminarFila(btn) {
        btn.closest('tr').remove();
        actualizarGranTotal();
    }
</script>
{% endblock %}